<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceDew Game Client</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Roboto:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <style>
        :root {
            --base-dark: #1a1f2c;
            --base-medium: #2d3446;
            --base-light: #3d465e;
            --neon-green: #39ff14;
            --neon-green-dim: #2ab50f;
            --retro-orange: #ff8b3d;
            --text-color: #d4e5f9;
            --border-glow: 0 0 5px var(--neon-green);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--base-dark);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        h1, h2 {
            font-family: 'Share Tech Mono', monospace;
            color: var(--neon-green);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--neon-green-dim);
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .panel {
            background: var(--base-medium);
            padding: 20px;
            border: 2px solid var(--base-light);
            border-radius: 8px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
            position: relative;
            height: fit-content;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent, 
                var(--neon-green-dim),
                transparent
            );
        }

        .top-section {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .left-column {
            width: 20%;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-self: flex-start;
        }

        .right-column {
            flex-grow: 1;
            align-self: flex-start;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .scrollable-summary {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--neon-green-dim);
            border-radius: 8px;
            background: var(--base-dark);
            font-family: 'Share Tech Mono', monospace;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            margin: 0;
            line-height: 1.4;
        }

        .scrollable-summary::-webkit-scrollbar {
            width: 12px;
        }

        .scrollable-summary::-webkit-scrollbar-track {
            background: var(--base-dark);
            border-radius: 6px;
        }

        .scrollable-summary::-webkit-scrollbar-thumb {
            background: var(--base-light);
            border-radius: 6px;
            border: 2px solid var(--base-dark);
        }

        .scrollable-summary br:first-child {
            display: none;
        }

        .scrollable-summary > *:first-child {
            margin-top: 0;
            padding-top: 0;
        }

        .panel h2 {
            margin: 0 0 15px 0;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group.horizontal {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        .form-group.horizontal > div {
            flex: 1;
        }

        .form-group.horizontal label {
            margin-bottom: 8px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--retro-orange);
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 1px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            background: var(--base-dark);
            border: 2px solid var(--base-light);
            border-radius: 4px;
            color: var(--text-color);
            font-family: 'Share Tech Mono', monospace;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--neon-green);
            box-shadow: var(--border-glow);
        }

        button {
            background-color: var(--base-light);
            color: var(--neon-green);
            padding: 12px 20px;
            border: 2px solid var(--neon-green);
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            background-color: var(--neon-green);
            color: var(--base-dark);
            box-shadow: var(--border-glow);
        }

        button:active {
            transform: translateY(1px);
        }

        .error {
            color: #ff4444;
            margin-top: 10px;
            font-family: 'Share Tech Mono', monospace;
            text-shadow: 0 0 5px rgba(255,68,68,0.5);
        }

        #apiUrl {
            width: 100%;
            margin-bottom: 20px;
            font-family: 'Share Tech Mono', monospace;
        }

        .game-grid {
            display: grid;
            gap: 3px;
            background-color: var(--base-light);
            padding: 3px;
            border: 2px solid var(--neon-green-dim);
            border-radius: 8px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
            margin-top: 20px;
        }

        .cell {
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            position: relative;
            background-color: var(--base-medium);
            border: 1px solid var(--base-light);
            border-radius: 4px;
            transition: all 0.3s ease;
            padding: 4px;
            overflow: hidden;
        }

        .cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.3);
        }

        .cell .coordinates {
            position: absolute;
            top: 2px;
            left: 2px;
            color: var(--text-color);
            font-size: 10px;
            font-family: 'Share Tech Mono', monospace;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            background-color: rgba(0, 0, 0, 0.3);
            padding: 1px 3px;
            border-radius: 2px;
            z-index: 2;
        }

        .cell .bot-label {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: var(--base-dark);
            color: var(--neon-green);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 10px;
            font-family: 'Share Tech Mono', monospace;
            border: 1px solid var(--neon-green-dim);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }

        .cell .asset-label {
            color: var(--text-color);
            text-align: center;
            margin: 2px 0;
            font-weight: bold;
            font-family: 'Share Tech Mono', monospace;
            text-shadow: 
                -1px -1px 2px rgba(0, 0, 0, 0.8),
                1px -1px 2px rgba(0, 0, 0, 0.8),
                -1px 1px 2px rgba(0, 0, 0, 0.8),
                1px 1px 2px rgba(0, 0, 0, 0.8);
            background-color: rgba(0, 0, 0, 0.4);
            padding: 2px 4px;
            border-radius: 2px;
            width: 100%;
            z-index: 2;
        }

        .bot-label {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: var(--base-dark);
            color: var(--neon-green);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 10px;
            font-family: 'Share Tech Mono', monospace;
            border: 1px solid var(--neon-green-dim);
        }

        .asset-label {
            color: var(--text-color);
            text-align: center;
            margin: 2px 0;
            font-weight: bold;
            font-family: 'Share Tech Mono', monospace;
            text-shadow: 
                -1px -1px 2px rgba(0,0,0,0.7),
                1px -1px 2px rgba(0,0,0,0.7),
                -1px 1px 2px rgba(0,0,0,0.7),
                1px 1px 2px rgba(0,0,0,0.7);
            background-color: rgba(0, 0, 0, 0.3);
            padding: 2px 4px;
            border-radius: 2px;
        }

        pre {
            background-color: var(--base-dark);
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-family: 'Share Tech Mono', monospace;
            border: 1px solid var(--base-light);
            color: var(--text-color);
        }

        /* Radio button styling */
        input[type="radio"] {
            width: auto;
            margin-right: 8px;
        }

        input[type="radio"] + label {
            display: inline;
            color: var(--text-color);
            text-transform: none;
            font-weight: normal;
        }

        .restart-button {
            margin-left: 10px;
            background-color: var(--retro-orange);
            color: var(--base-dark);
        }
        
        .restart-button:hover {
            background-color: var(--neon-green);
            color: var(--base-dark);
        }

        .bottom-section {
            background: var(--base-medium);
            padding: 20px;
            border: 2px solid var(--base-light);
            border-radius: 8px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
            position: relative;
        }
        .toggle-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .toggle-button {
            background-color: var(--base-dark);
            color: var(--neon-green);
            padding: 8px 16px;
            border: 2px solid var(--neon-green-dim);
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .toggle-button.active {
            background-color: var(--neon-green);
            color: var(--base-dark);
            box-shadow: var(--border-glow);
        }
        #eventLog, #rawState {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: var(--base-dark);
            border: 1px solid var(--neon-green-dim);
            border-radius: 4px;
            font-family: 'Share Tech Mono', monospace;
            color: var(--text-color);
            margin-top: 10px;
        }

        .secondary-button {
            background-color: var(--base-dark);
            color: var(--neon-green);
            padding: 8px 16px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .card-list {
            background: var(--base-dark);
            border: 1px solid var(--base-light);
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            min-height: 50px;
            max-height: 150px;
            overflow-y: auto;
        }

        .card-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid var(--base-light);
        }

        .card-list-item:last-child {
            border-bottom: none;
        }

        .remove-card {
            color: #ff4444;
            cursor: pointer;
            background: none;
            border: none;
            font-family: 'Share Tech Mono', monospace;
            padding: 2px 6px;
        }

        .remove-card:hover {
            background-color: rgba(255, 68, 68, 0.2);
        }

        select[multiple] {
            height: auto;
            min-height: 120px;
        }

        .level-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .level-controls select {
            flex-grow: 1;
        }

        .level-controls .restart-button {
            margin: 0;
            white-space: nowrap;
        }

        .level-select-group {
            margin-top: 20px;
            border-top: 1px solid var(--base-light);
            padding-top: 20px;
        }

        #rawState {
            padding: 0 !important;
            background: transparent !important;
            border: none !important;
        }

        #rawState pre {
            margin: 0;
            border-radius: 8px;
            background: var(--base-dark) !important;
        }

        #rawState code {
            font-family: 'Share Tech Mono', monospace !important;
            font-size: 14px !important;
            line-height: 1.4 !important;
        }

        .hljs {
            background: var(--base-dark) !important;
            padding: 15px !important;
        }

        .control-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 20px;
            padding: 4px;
            background: #2a2a2a;
            border-radius: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            font-family: 'VT323', monospace;
            font-size: 1.2em;
            text-align: center;
            color: #c0c0c0;
            background: linear-gradient(145deg, #3a3a3a 0%, #2a2a2a 100%);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            text-transform: uppercase;
            box-shadow: 
                0 1px 2px rgba(0,0,0,0.2),
                inset 0 1px 1px rgba(255,255,255,0.1);
        }

        .tab-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(139, 69, 19, 0.05),
                rgba(139, 69, 19, 0.1)
            );
            border-radius: 4px;
            pointer-events: none;
        }

        .tab-button:hover {
            background: linear-gradient(145deg, #404040 0%, #303030 100%);
            transform: translateY(-1px);
        }

        .tab-button.active {
            background: linear-gradient(145deg, #ff6b4a 0%, #cc4f35 100%);
            color: #1a1a1a;
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                inset 0 1px 1px rgba(255,255,255,0.2);
            transform: translateY(1px);
        }

        .tab-button.active::before {
            background: linear-gradient(45deg,
                rgba(255, 255, 255, 0.1),
                rgba(255, 255, 255, 0.05)
            );
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Help Button and Modal Styles */
        .help-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(145deg, #3a3a3a 0%, #2a2a2a 100%);
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            font-family: 'Share Tech Mono', monospace;
            font-size: 20px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                inset 0 1px 1px rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .help-button:hover {
            background: linear-gradient(145deg, #404040 0%, #303030 100%);
            transform: translateY(-1px);
            box-shadow: 
                0 4px 8px rgba(57, 255, 20, 0.2),
                inset 0 1px 1px rgba(255,255,255,0.2);
        }

        .help-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            background: var(--base-medium);
            border: 2px solid var(--neon-green);
            border-radius: 8px;
            padding: 20px;
            z-index: 1001;
            overflow-y: auto;
            box-shadow: 
                0 0 20px rgba(0,0,0,0.5),
                inset 0 0 10px rgba(57, 255, 20, 0.1);
        }

        .help-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(45deg, 
                    rgba(139, 69, 19, 0.05),
                    rgba(139, 69, 19, 0.1)
                ),
                url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1IiBoZWlnaHQ9IjUiPgo8cmVjdCB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSIjMjIyIj48L3JlY3Q+CjxwYXRoIGQ9Ik0wIDVMNSAwWk02IC00TDQgNlpNLTQgNkw2IC00WiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjEiPjwvcGF0aD4KPC9zdmc+');
            border-radius: 6px;
            z-index: -1;
            opacity: 0.1;
        }

        .help-modal-content {
            font-family: 'Share Tech Mono', monospace;
            color: var(--text-color);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .help-modal h2 {
            color: var(--neon-green);
            margin-top: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--neon-green-dim);
        }

        .help-modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-modal-close:hover {
            color: var(--neon-green);
            transform: scale(1.1);
        }

        .help-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        /* Turn Grid Styles */
        .turn-grid {
            background: var(--base-medium);
            border: 2px solid var(--base-light);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Share Tech Mono', monospace;
        }

        .turn-table {
            width: 100%;
            border-collapse: collapse;
        }

        .turn-table td {
            width: 60px;
            height: 40px;
            text-align: center;
            vertical-align: middle;
            border: 1px solid var(--base-light);
            position: relative;
        }

        .bot-row td {
            background: var(--base-dark);
        }

        .bot-label {
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--neon-green);
            font-size: 0.8em;
            text-align: left;
        }

        .card-slot {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8em;
            color: var(--neon-green);
            text-align: center;
            padding: 0 4px;
        }

        .card-slot:hover {
            background: var(--base-light);
        }

        .card-slot.marked-for-removal {
            position: relative;
        }

        .card-slot.marked-for-removal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 0, 0, 0.7);
        }

        .hour-marker {
            color: var(--text-color);
            font-size: 0.9em;
            position: relative;
        }

        .hour-marker::after {
            content: '|';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--base-light);
        }

        .hour-marker.awake {
            color: var(--retro-orange);
        }

        .hour-selector {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            height: 40px;
            padding: 0;
        }

        .hour-selector .day-hour {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            line-height: 1;
            padding: 2px;
        }

        .hour-selector .day-hour .day {
            transform: translateX(-5px) translateY(3px);
            font-size: 0.8em;
            color: var(--neon-green);

        }

        .hour-selector .day-hour .hour {
            transform: translateX(5px) translateY(-3px);
        }

        .hour-selector .day-hour .slash {
            position: absolute;
            font-size: 1.2em;
            color: var(--base-light);
        }

        .hour-selector:hover {
            background: var(--base-light);
        }

        .hour-selector.selected {
            background: var(--retro-orange);
            color: var(--base-dark);
        }

        .hour-selector.selected .day-hour .day,
        .hour-selector.selected .day-hour .slash {
            color: var(--base-dark);
        }

        .add-card-button {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--base-dark);
            border: 1px dashed var(--base-light);
            color: var(--neon-green);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-card-button:hover {
            border-color: var(--neon-green);
            box-shadow: var(--border-glow);
        }

        .play-button {
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            background: linear-gradient(145deg, var(--neon-green-dim) 0%, var(--neon-green) 100%);
            border: none;
            border-radius: 4px;
            color: var(--base-dark);
            font-family: 'Share Tech Mono', monospace;
            font-size: 18px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Card Creation Modal Styles */
        .card-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--base-medium);
            border: 2px solid var(--neon-green);
            border-radius: 8px;
            padding: 20px;
            z-index: 1001;
            width: 300px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .card-modal h3 {
            color: var(--neon-green);
            margin-top: 0;
            margin-bottom: 20px;
            font-family: 'Share Tech Mono', monospace;
        }

        .card-modal select {
            width: 100%;
            margin-bottom: 15px;
            background: var(--base-dark);
            border: 1px solid var(--base-light);
            color: var(--text-color);
            padding: 8px;
            border-radius: 4px;
            font-family: 'Share Tech Mono', monospace;
        }

        .card-modal select:focus {
            border-color: var(--neon-green);
            box-shadow: var(--border-glow);
        }

        .card-modal button {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: var(--neon-green);
            color: var(--base-dark);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-modal button:hover {
            background: var(--neon-green-dim);
            box-shadow: var(--border-glow);
        }

        .card-modal button.cancel {
            background: var(--base-light);
            color: var(--text-color);
            margin-top: 5px;
        }

        .card-modal button.cancel:hover {
            background: var(--base-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sleep Pod Farmer - <span id="gameStatusTitle">Day 1 Hour 1</span></h1>
        <button id="help-button" class="help-button" onclick="showHelp()">?</button>
        
        <div class="turn-grid">
            <table class="turn-table">
                <tbody>
                    <!-- Bot rows will be inserted here -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="25">
                            <button class="play-button" id="play-button">Play Turn</button>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div id="card-modal" class="card-modal">
            <h3>Add New Card</h3>
            <select id="action-type">
                <option value="MOVE">Move</option>
                <option value="HARVEST">Harvest</option>
                <option value="PLANT">Plant</option>
            </select>
            <div id="direction-container">
                <select id="direction">
                    <option value="NORTH">North</option>
                    <option value="SOUTH">South</option>
                    <option value="EAST">East</option>
                    <option value="WEST">West</option>
                </select>
            </div>
            <div id="asset-container" style="display: none;">
                <select id="asset-type">
                    <!-- Will be populated by JavaScript -->
                </select>
            </div>
            <button id="add-card-confirm">Add Card</button>
            <button id="cancel-card" class="cancel">Cancel</button>
        </div>
        
        <div class="top-section">
            <div class="left-column">
                <div class="panel">
                    <h2 id="gameStatusTitle">Game Status</h2>
                    <div id="gameStatus" class="scrollable-summary">
                        <!-- Game status will be inserted here -->
                    </div>
                </div>

                <div class="panel">
                    <h2 id="levelTitle">Level</h2>
                    
                    <div class="form-group">
                        <label>Goals:</label>
                        <div id="gameConfig" class="scrollable-summary">
                            <!-- Victory conditions will be inserted here -->
                        </div>
                    </div>

                    <div class="form-group level-select-group">
                        <label for="levelSelect">Change Level:</label>
                        <div class="level-controls">
                            <select id="levelSelect"></select>
                            <button onclick="restartGame()" class="restart-button">Restart Level</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="panel">
                    <h2>Game Grid</h2>
                    <div id="gameGrid">
                        <!-- Game grid will be inserted here -->
                    </div>
                </div>
                
                <div class="panel">
                    <div class="toggle-container">
                        <button class="toggle-button active" onclick="toggleView('eventLog')">Event Log</button>
                        <button class="toggle-button" onclick="toggleView('rawState')">Raw State</button>
                    </div>
                    <div id="eventLog"><!-- Event log will be inserted here --></div>
                    <div id="rawState" style="display: none;"><!-- Raw state will be inserted here --></div>
                </div>
                
                <div id="error" class="error"></div>
            </div>
        </div>
    </div>

    <div id="help-modal" class="help-modal">
        <button class="help-modal-close" onclick="hideHelp()">×</button>
        <div class="help-modal-content">
            <h2>SpaceDew Help</h2>
            <div id="helpText"></div>
        </div>
    </div>
    <div class="help-overlay" id="helpOverlay" onclick="hideHelp()"></div>

    <script>
        // Asset type colors
        const ASSET_COLORS = {
            'PLANT': "#228B22",       // Forest green for any plant
            'PLANT_SEEDLING': "#98FB98", // Light green for any seedling
            'TOMATO': "#228B22",      // Forest green
            'POTATO': "#228B22",      // Forest green
            'CORN': "#228B22",        // Forest green
            'TOMATO_SEED': "#98FB98", // Light green
            'POTATO_SEED': "#98FB98", // Light green
            'CORN_SEED': "#98FB98",   // Light green
            'COAL': "#666666",        // Medium gray
            'IRON': "#CD853F",        // Peru (brownish)
            'COPPER': "#B87333",      // Copper
            'COAL_ORE': "#A9A9A9",    // Darker gray
            'IRON_ORE': "#DEB887",    // Burlywood (lighter brown)
            'COPPER_ORE': "#DAA520"   // Goldenrod
        };

        let gameState = null;
        let selectedCardsToRemove = new Set();
        let currentBotId = null;
        let sleepHours = 8;

        // Initialize the time track and bot rows
        function initializeTimeTrack() {
            const tbody = document.querySelector('.turn-table tbody');
            tbody.innerHTML = '';
            
            // Add hour selector row
            const selectorRow = document.createElement('tr');
            selectorRow.className = 'hour-selector-row';
            
            // Add empty cell for bot labels
            const selectorLabelCell = document.createElement('td');
            selectorRow.appendChild(selectorLabelCell);
            
            // Add hour selector cells (1-24)
            for (let i = 0; i < 24; i++) {
                const cell = document.createElement('td');
                cell.className = 'hour-selector';
                
                // Calculate day and hour based on current game state
                const currentHour = gameState ? gameState.hour : 0;
                const currentDay = gameState ? gameState.day : 0;
                const targetHour = currentHour + i;  // Show the hour we'll sleep through
                const day = currentDay + Math.floor(targetHour / 24);
                const hour = targetHour % 24;
                
                // Create day/hour display
                const dayHourDiv = document.createElement('div');
                dayHourDiv.className = 'day-hour';
                
                const daySpan = document.createElement('span');
                daySpan.className = 'day';
                daySpan.textContent = day;
                
                const slashSpan = document.createElement('span');
                slashSpan.className = 'slash';
                slashSpan.textContent = '/';
                
                const hourSpan = document.createElement('span');
                hourSpan.className = 'hour';
                hourSpan.textContent = hour;
                
                dayHourDiv.appendChild(daySpan);
                dayHourDiv.appendChild(slashSpan);
                dayHourDiv.appendChild(hourSpan);
                cell.appendChild(dayHourDiv);
                
                // Store the number of hours to sleep (1 more than the index)
                cell.dataset.hour = i + 1;
                
                // Mark waking hours (6-22)
                if (hour >= 6 && hour <= 22) {
                    cell.classList.add('awake');
                }
                
                cell.addEventListener('click', () => {
                    // Remove selected class from all cells
                    document.querySelectorAll('.hour-selector').forEach(c => c.classList.remove('selected'));
                    // Add selected class to clicked cell
                    cell.classList.add('selected');
                    // Calculate sleep hours based on difference between clicked hour and current hour
                    const currentHour = gameState ? gameState.hour : 0;
                    const clickedHour = targetHour;
                    sleepHours = (clickedHour - currentHour) + 1;
                });
                
                selectorRow.appendChild(cell);
            }
            
            tbody.appendChild(selectorRow);
        }

        // Initialize bot rows
        function initializeBotRows() {
            const tbody = document.querySelector('.turn-table tbody');
            
            // Remove all existing bot rows (keep the hour selector row)
            const hourSelectorRow = tbody.querySelector('.hour-selector-row');
            tbody.innerHTML = '';
            if (hourSelectorRow) {
                tbody.appendChild(hourSelectorRow);
            }
            
            if (!gameState || !gameState.controllers) return;
            
            const controller = gameState.controllers[0]; // Using first controller for now
            
            for (let botId = 0; botId < controller.bots.length; botId++) {
                const bot = controller.bots[botId];
                const row = document.createElement('tr');
                row.className = 'bot-row';
                
                // Add bot label cell
                const labelCell = document.createElement('td');
                const label = document.createElement('div');
                label.className = 'bot-label';
                label.textContent = `Bot ${botId}`;
                labelCell.appendChild(label);
                row.appendChild(labelCell);
                
                // Add cards
                for (let i = 0; i < bot.deck.length; i++) {
                    const card = bot.deck[i];
                    const cell = document.createElement('td');
                    const cardSlot = document.createElement('div');
                    cardSlot.className = 'card-slot';
                    cardSlot.textContent = formatCard(card);
                    cardSlot.dataset.botId = botId;
                    cardSlot.dataset.cardIndex = i;
                    
                    cardSlot.addEventListener('click', () => toggleCardRemoval(cardSlot));
                    cell.appendChild(cardSlot);
                    row.appendChild(cell);
                }
                
                // Add the "+" button
                const addCell = document.createElement('td');
                const addButton = document.createElement('div');
                addButton.className = 'add-card-button';
                addButton.textContent = '+';
                addButton.dataset.botId = botId;
                addButton.addEventListener('click', () => showCardModal(botId));
                addCell.appendChild(addButton);
                row.appendChild(addCell);
                
                tbody.insertBefore(row, tbody.firstChild);
            }
        }

        function formatCard(card) {
            if (card.action_type === 'MOVE') {
                return `M${card.parameter[0]}`; // M for Move, first letter of direction
            } else if (card.action_type === 'HARVEST') {
                return `H${card.parameter[0]}`; // H for Harvest, first letter of asset
            } else if (card.action_type === 'PLANT') {
                return `P${card.parameter[0]}`; // P for Plant, first letter of asset
            }
            return card.action_type[0];
        }

        // Toggle card removal
        function toggleCardRemoval(cardSlot) {
            const botId = cardSlot.dataset.botId;
            const cardIndex = cardSlot.dataset.cardIndex;
            const key = `${botId}-${cardIndex}`;
            
            if (selectedCardsToRemove.has(key)) {
                selectedCardsToRemove.delete(key);
                cardSlot.classList.remove('marked-for-removal');
            } else {
                selectedCardsToRemove.add(key);
                cardSlot.classList.add('marked-for-removal');
            }
        }

        // Show card creation modal
        function showCardModal(botId) {
            currentBotId = botId;
            const modal = document.getElementById('card-modal');
            modal.style.display = 'block';
            
            // Reset selections
            document.getElementById('action-type').value = 'MOVE';
            document.getElementById('direction').value = 'NORTH';
            updateCardModalFields();
        }

        // Update card modal fields based on action type
        function updateCardModalFields() {
            const actionType = document.getElementById('action-type').value;
            const directionDiv = document.getElementById('direction-container');
            const assetDiv = document.getElementById('asset-container');
            
            if (actionType === 'MOVE') {
                directionDiv.style.display = 'block';
                assetDiv.style.display = 'none';
                
                // Update direction options
                const directionSelect = document.getElementById('direction');
                directionSelect.innerHTML = `
                    <option value="NORTH">North</option>
                    <option value="SOUTH">South</option>
                    <option value="EAST">East</option>
                    <option value="WEST">West</option>
                `;
            } else {
                directionDiv.style.display = 'none';
                assetDiv.style.display = 'block';
                
                // Update asset options based on action type
                const assetSelect = document.getElementById('asset-type');
                if (actionType === 'HARVEST') {
                    assetSelect.innerHTML = `
                        <option value="ORE">Ore</option>
                        <option value="PLANT">Plant</option>
                        <option value="COAL">Coal</option>
                    `;
                } else if (actionType === 'PLANT') {
                    assetSelect.innerHTML = `
                        <option value="ORE_SEEDLING">Ore Seedling</option>
                        <option value="PLANT_SEEDLING">Plant Seedling</option>
                        <option value="COAL_SEEDLING">Coal Seedling</option>
                    `;
                }
            }
        }

        // Handle card creation
        function handleCardCreation() {
            const actionType = document.getElementById('action-type').value;
            let parameters = {};
            
            if (actionType === 'MOVE') {
                parameters.direction = document.getElementById('direction').value;
            } else {
                parameters.asset_type = document.getElementById('asset-type').value;
            }
            
            // Send request to add card
            const orders = [{
                controller_id: 0,
                action_type: 'MODIFY_DECK',
                parameters: {
                    bot_id: parseInt(currentBotId),
                    cards: [{
                        action_type: actionType,
                        parameter: actionType === 'MOVE' ? parameters.direction : parameters.asset_type
                    }]
                }
            }];
            
            submitTurn(orders);
            document.getElementById('card-modal').style.display = 'none';
        }

        // Submit turn
        async function submitTurn(additionalOrders = []) {
            const orders = [...additionalOrders];
            if (gameState.state !== 'active') {
                console.log("Game is not active, skipping turn");
                alert("Game is not active.");
                return;
            }
            // Add card removal orders if any cards are marked for removal
            if (selectedCardsToRemove.size > 0) {
                const removalsByBot = new Map();
                
                // Group removals by bot
                for (const key of selectedCardsToRemove) {
                    const [botId, cardIndex] = key.split('-');
                    if (!removalsByBot.has(botId)) {
                        removalsByBot.set(botId, []);
                    }
                    removalsByBot.get(botId).push(parseInt(cardIndex));
                }
                
                // Create removal orders for each bot
                for (const [botId, indices] of removalsByBot) {
                    orders.push({
                        controller_id: 0,
                        action_type: 'MODIFY_DECK',
                        parameters: {
                            bot_id: parseInt(botId),
                            removed_ids: indices
                        }
                    });
                }
            }
            
            // Add sleep order if no other orders are present
            if (orders.length === 0) {
                orders.push({
                    controller_id: 0,
                    action_type: 'TAKE_BOT_ACTIONS',
                    parameters: {
                        energy_points: sleepHours
                    }
                });
            }
            
            try {
                const response = await fetch('/game/turn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ orders })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    gameState = result;
                    selectedCardsToRemove.clear();
                    initializeTimeTrack();
                    initializeBotRows();
                    renderGameGrid(result);
                    document.getElementById('gameStatus').innerHTML = generateGameStatus(result);
                    document.getElementById('gameStatusTitle').innerHTML = generateGameTime(result);
                    document.getElementById('gameConfig').innerHTML = generateGameConfig(result);
                    document.getElementById('eventLog').innerHTML = generateEventLog(result);
                    document.getElementById('rawState').innerHTML = `<pre><code class="language-json">${JSON.stringify(result, null, 2)}</code></pre>`;
                    hljs.highlightElement(document.querySelector('#rawState code'));
                } else {
                    const error = await response.text();
                    document.getElementById('error').textContent = error;
                }
            } catch (error) {
                console.error('Error submitting turn:', error);
                document.getElementById('error').textContent = error.message;
            }
        }

        // Event listeners
        document.getElementById('action-type').addEventListener('change', updateCardModalFields);
        document.getElementById('add-card-confirm').addEventListener('click', handleCardCreation);
        document.getElementById('cancel-card').addEventListener('click', () => {
            document.getElementById('card-modal').style.display = 'none';
        });
        
        document.getElementById('play-button').addEventListener('click', () => submitTurn());

        // Help modal functions
        function showHelp() {
            document.getElementById('help-modal').style.display = 'block';
            document.getElementById('helpOverlay').style.display = 'block';
            
            // Set help text
            document.getElementById('helpText').innerHTML = `
Your space ship, the "Stardew Valley", has crashed!
You are able to stay alive inside the wreck mostly by sleeping in your suspended animation pod to reduce resource usage.
To gather enough resources to survive and eventually repair your ship, you'll need to gather and grow from the outside world which you cannot visit.
Luckily, you have built a Bot which can take your orders in the outside world and perform your tasks.
You will need to give it its orders then return to sleep while it performs them.
The longer you can let it run while you sleep the more efficient your operation will be, but the harder it will be adapt to any changes or challenges to the assumptions underlying your orders.

Your primary control is how to spend the hours of your days. While you sleep your bots will perform your given tasks. Reprogramming the bots or building new ones will require you to be awake, which consumes your precious biomass.

Resources:
• Biomass: perform waking tasks
• Energy: perform bot actions and tasks
• Metal: build new machinery and components

Controls:
• Bot Actions: let N hours pass, consuming no biomass while bots work
• Edit Deck: reconfigure your bots, consuming biomass
• Create Bot: Create new bot out of metal

Each scenario will have a set of goals to be accomplished - generally needed amounts of resources.`;
        }

        function hideHelp() {
            document.getElementById('help-modal').style.display = 'none';
            document.getElementById('helpOverlay').style.display = 'none';
        }

        // Initialize the interface
        initializeTimeTrack();
        
        // Load initial game state
        async function loadGameState() {
            try {
                const response = await fetch('/game/state');
                if (!response.ok) {
                    throw new Error('Failed to fetch game state');
                }
                const state = await response.json();
                gameState = state;
                
                // Initialize all displays
                initializeTimeTrack();
                initializeBotRows();

                renderGameGrid(state);
                document.getElementById('gameStatus').innerHTML = generateGameStatus(state);
                document.getElementById('gameStatusTitle').innerHTML = generateGameTime(state);
                document.getElementById('gameConfig').innerHTML = generateGameConfig(state);
                document.getElementById('eventLog').innerHTML = generateEventLog(state);
                document.getElementById('rawState').innerHTML = `<pre><code class="language-json">${JSON.stringify(state, null, 2)}</code></pre>`;
                hljs.highlightElement(document.querySelector('#rawState code'));
                
                // Load levels
                await loadLevels();
            } catch (error) {
                console.error('Error loading game state:', error);
                document.getElementById('error').textContent = error.message;
            }
        }

        // Load initial state
        loadGameState();

        // Game grid rendering functions
        function renderGameGrid(gameState) {
            const gridContainer = document.getElementById('gameGrid');
            const width = gameState.map_size.width;
            const height = gameState.map_size.height;
            
            gridContainer.innerHTML = '';
            gridContainer.className = 'game-grid';
            gridContainer.style.gridTemplateColumns = `repeat(${width}, 60px)`;
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const cell = gameState.map[y][x];
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'cell';
                    
                    // Set background color based on assets
                    if (cell.assets && cell.assets.length > 0) {
                        const assetType = cell.assets[0].type;
                        // console.log(`Cell (${x},${y}) has asset type: ${assetType}, color: ${ASSET_COLORS[assetType]}`);
                        
                        // Get the color for this asset type
                        let color = ASSET_COLORS[assetType];
                        
                        // If no specific color found, try to use a generic type color
                        if (!color && assetType.includes('PLANT')) {
                            color = ASSET_COLORS['PLANT'];
                        } else if (!color && assetType.includes('SEEDLING')) {
                            color = ASSET_COLORS['PLANT_SEEDLING'];
                        }
                        
                        if (color) {
                            cellDiv.style.setProperty('background-color', color, 'important');
                            // console.log(`Applied color ${color} to cell (${x},${y})`);
                        }
                    }
                    
                    // Add coordinates
                    const coords = document.createElement('div');
                    coords.className = 'coordinates';
                    coords.textContent = `(${x},${y})`;
                    cellDiv.appendChild(coords);
                    
                    // Add bot label if there are bots
                    if (cell.bots && cell.bots.length > 0) {
                        const botCounts = {};
                        cell.bots.forEach(bot => {
                            botCounts[bot.controller_id] = (botCounts[bot.controller_id] || 0) + 1;
                        });
                        
                        const botLabel = document.createElement('div');
                        botLabel.className = 'bot-label';
                        const labels = [];
                        for (const [controllerId, count] of Object.entries(botCounts)) {
                            labels.push(count > 1 ? `C${controllerId}×${count}` : `C${controllerId}`);
                        }
                        botLabel.textContent = labels.join(' ');
                        cellDiv.appendChild(botLabel);
                    }
                    
                    // Add asset labels
                    if (cell.assets && cell.assets.length > 0) {
                        cell.assets.forEach(asset => {
                            const assetLabel = document.createElement('div');
                            assetLabel.className = 'asset-label';
                            const shortType = asset.type.split('_')[0].substring(0, 3);
                            assetLabel.textContent = asset.maturity_time !== null 
                                ? `${shortType}(${asset.maturity_time})`
                                : `${shortType}×${asset.amount}`;
                            cellDiv.appendChild(assetLabel);
                        });
                    }
                    
                    gridContainer.appendChild(cellDiv);
                }
            }
        }

        // Game state display functions
        function generateGameStatus(gameState) {
            let status = ["STATUS: " + gameState.state + "<br>"];
            

            // Add controller information
            for (const controller of gameState.controllers) {
                // Add resources vertically
                status.push('<BR>Resources:');
                Object.entries(controller.resources).forEach(([resource, amount]) => {
                    status.push(`<br>${resource}: ${amount}`);
                });
            }
            
            return status.join('');
        }

        function generateGameTime(gameState) {
            return `Day ${gameState.day} Hour ${gameState.hour}`;
        }

        function generateGameConfig(gameState) {
            let status = [];
            
            // Add victory conditions
            status.push('Goals:');
            for (const [resource, amount] of Object.entries(gameState.victory_conditions)) {
                status.push(`<br>${resource}: ${amount}`);
            }
            
            return status.join('');
        }

        function generateEventLog(gameState) {
            if (!gameState.event_log || gameState.event_log.length === 0) {
                return "No events yet.";
            }

            let log = [];
            for (const event of gameState.event_log) {
                log.push(`Day ${event.day}, Hour ${event.hour}: ${event.message}`);
            }
            return log.join('<br>');
        }

        function toggleView(viewId) {
            const eventLog = document.getElementById('eventLog');
            const rawState = document.getElementById('rawState');
            const buttons = document.querySelectorAll('.toggle-button');
            
            if (viewId === 'eventLog') {
                eventLog.style.display = 'block';
                rawState.style.display = 'none';
            } else {
                eventLog.style.display = 'none';
                rawState.style.display = 'block';
            }
            
            buttons.forEach(button => {
                button.classList.toggle('active', button.textContent.toLowerCase().includes(viewId.toLowerCase()));
            });
        }

        // Level management functions
        async function loadLevels() {
            try {
                const response = await fetch('/game/levels');
                if (!response.ok) {
                    throw new Error('Failed to fetch levels');
                }
                const data = await response.json();
                
                // Update level select dropdown
                const levelSelect = document.getElementById('levelSelect');
                levelSelect.innerHTML = data.levels.map(level => 
                    `<option value="${level}" ${level === data.current_level ? 'selected' : ''}>${level}</option>`
                ).join('');

                // Update the level title
                document.getElementById('levelTitle').textContent = data.current_level;
            } catch (error) {
                console.error('Error loading levels:', error);
                document.getElementById('error').textContent = 'Error loading levels: ' + error.message;
            }
        }

        async function restartGame() {
            const level = document.getElementById('levelSelect').value;
            try {
                const response = await fetch(`/game/restart?level=${level}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                // Clear error message if successful
                document.getElementById('error').textContent = '';
                
                // Update game state
                const data = await response.json();
                gameState = data;
                
                // Update all displays
                renderGameGrid(data);
                initializeBotRows();
                document.getElementById('gameStatus').innerHTML = generateGameStatus(data);
                document.getElementById('gameStatusTitle').innerHTML = generateGameTime(data);
                document.getElementById('gameConfig').innerHTML = generateGameConfig(data);
                document.getElementById('eventLog').innerHTML = generateEventLog(data);
                document.getElementById('rawState').innerHTML = `<pre><code class="language-json">${JSON.stringify(data, null, 2)}</code></pre>`;
                hljs.highlightElement(document.querySelector('#rawState code'));
                
                // Update the level title
                document.getElementById('levelTitle').textContent = level;
                
            } catch (error) {
                console.error('Error restarting game:', error);
                document.getElementById('error').textContent = error.message;
            }
        }
    </script>
</body>
</html> 